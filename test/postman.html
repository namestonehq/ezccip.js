<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CCIP-Read Postman</title>
<style>
.hide { display: none !important; }
.balloon { flex: 1; }
body {
	margin: 3rem;
	background: #eee;
}
button:not(:disabled) {	
	cursor: pointer;
	padding: 4px 8px;
}
select {
	padding: 4px 8px;
	font-size: 100%;
}
header {
	display: flex;
	justify-content: space-between;
}
h1 {
	display: flex;
	margin: 0;
	align-items: baseline;
	gap: 16px;
}
.rows {
	display: flex;
	flex-direction: column;
	gap: 8px;
}
#config .field {
	display: flex;
}
.wide label {
	display: flex;
	flex-wrap: wrap;
	align-items: center;
	gap: 4px;
	margin-bottom: 8px;
}
label i {
	margin-left: auto;
	opacity: .7;
}
.wide input,
.wide textarea {
	display: block;
	width: 100%;
	box-sizing: border-box;
	padding: 8px;
	font-size: 150%;
}
.wide textarea {
	min-height: 48px;
	resize: vertical;
}
#method_span {
	padding: 2px 4px;
	border-radius: 4px;
	background-color: #afa;
	border: 1px solid #ccc;
	font: 12px sans-serif;
}
#method_span:empty {
	display: none;
}
.field {
	display: flex;
	gap: 8px;
}
#actions {
	display: flex;
	align-items: center;
	gap: 8px;
}
#actions button {
	padding: 8px;
	font-size: 100%;
}
#test_btn {
	margin-left: 8px;
	font-weight: bold;
}
.spinner {
	width: 24px;
	height: 24px;
	box-sizing: border-box;
	animation: spin 2s infinite linear;
	border: 4px solid #000;
	border-bottom-color: transparent;
	border-radius: 100%;
}
@keyframes spin {
	to { transform:rotate(360deg); }
}
footer {
	text-align: center;
	color: #666;
	margin: 16px;
}
@media only screen and (max-width: 800px) { 
	body {
		margin: 1rem;
	}
}
#note {
	display: block;
	margin: 8px auto;
	border: 2px dashed #cc0;
	padding: 8px;
	background-color: #ffc;
	text-align: center;
}
</style>
</head>
<body>
<header>
	<h1>CCIP-Read Postman</h1>
	<a href="https://github.com/resolverworks/ezccip.sol">resolverworks/ezccip.js</a>
</header>
<div id="note">⚠️ Under Construction</div>
<main>
<div id="config" class="rows">
	<div class="wide" id="endpoint">
		<label for="endpoint_field"><span id="method_span"></span>Endpoint<i></i></label>
		<input class="big" id="endpoint_field" placeholder="https://raffy.xyz/tog/">
	</div>
	<div id="options">
		<select id="func_select">
			<option value="ensip10">ENSIP-10: resolve(name, ...)</option>
			<option value="custom">EIP-3668: custom(...)</option>
		</select>
	</div>
	<div id="ensip10" class="rows">
		<div class="wide" id="name">
			<label for="name_field">ENS Name<i></i></label>
			<input class="big" id="name_field" placeholder="raffy.eth">
		</div>
		<div class="wide">
			<span id="field_count_lbl">0 fields</span>
			<button id="add_field_btn">✍️ Add Field</button>
		</div>
	</div>
	<div id="custom" class="rows hide">
		<div class="wide" id="abi">
			<label for="abi_ta">ABI<i></i></label>
			<textarea id="abi_ta" rows="3" placeholder="function f(uint256, uint256) view returns (uint256)"></textarea>
		</div>
		<div class="wide" id="args">
			<label for="abi_ta">Arguments (one line per argument)<i></i></label>
			<textarea name="abi_ta" rows="5" placeholder="arg1&#10;arg2"></textarea>
		</div>
	</div>
	<div id="actions">
		<div id="spinner" class="spinner hide"></div>
		<span class="balloon"></span>
		<label for="protocol_select">Protocol:</label>
		<select id="protocol_select">
			<option value="raw">Raw</option>
			<option value="ens">ENS</option>
			<option value="tor" selected>TOR</option>
		</select>
		<button id="test_btn" disabled>Call</button>
	</div>
</div>
<div id="output"></div>	
</main>
<footer>
	<span>Created by <a href="https://x.com/adraffy">raffy.eth</a></span>
</footer>
<script type="module">
import {ens_normalize} from '../../ens-normalize.js/dist/index.min.js';
import {ethers} from 'https://cdnjs.cloudflare.com/ajax/libs/ethers/6.12.1/ethers.min.js';

const TEMPLATE_DATA = '{data}';
const TEMPLATE_SENDER = '{sender}';

const endpoint_field = document.querySelector('#endpoint input');
const method_span = document.querySelector('#method_span');
const endpoint_status = document.querySelector('#endpoint label i');
const func_select = document.querySelector('#func_select');
const test_btn = document.querySelector('#test_btn');
const ensip10_div = document.querySelector('#ensip10');
const name_field = document.querySelector('#name input');
const name_status = document.querySelector('#name label i');
const custom_div = document.querySelector('#custom')
const abi_ta = document.querySelector('#abi textarea');
const abi_status = document.querySelector('#abi label i');
const args_ta = document.querySelector('#args textarea');
const main_spinner = document.querySelector('#actions .spinner');
const add_field_btn = document.querySelector('#add_field_btn');

let call_state;

endpoint_field.addEventListener('input', update_ux);
name_field.addEventListener('input', update_ux);
func_select.addEventListener('input', update_func);
abi_ta.addEventListener('input', update_func);
args_ta.addEventListener('input', update_func);
test_btn.addEventListener('click', try_call);
add_field_btn.addEventListener('click', () => add_field());

update_func();
endpoint_field.focus();


function is_custom() {
	return func_select.value === 'custom';
}

function parse_endpoint() {
	try {
		let url = new URL(endpoint_field.value.trim());
		url = decodeURI(url.toString());
		let has_data = url.includes(TEMPLATE_DATA);
		// let sender = str.includes(TEMPLATE_SENDER);
		// if (sender != data) throw new Error('expected {sender} and {data}');
		method_span.innerText = `${has_data ? 'GET' : 'POST'}`;
		endpoint_status.innerText = '';
		return url;
	} catch (err) {
		method_span.innerText = '';
		endpoint_status.innerText = `⚠️ ${err.message}`;
	}
}

function update_abi() {
	try {
		let abi = new ethers.Interface(abi_ta.value.split('\n').map(s => s.trim()).filter(x => x));
		let funcs = abi.fragments.filter(f => ethers.Fragment.isFunction(f));
		abi_status.innerText = '';
		if (!funcs.length)
		if (funcs.length != 1) throw new Error('expected one function');
		let func = funcs[0];
		return {abi, func};
	} catch (err) {
		abi_status.innerText = `⚠️ ${err.message}`;
	}
	return {};
}

function update_name() {
	try {
		let norm = ens_normalize(name_field.value.trim());
		if (!norm) throw new Error('empty name');
		name_status.innerText = '';
		return norm;
	} catch (err) {
		name_status.innerText = `⚠️ ${err.message}`;
	}
}

function update_ux() {
	main_spinner.classList.toggle('hide', !call_state);
	let ok = true;
	let url = parse_endpoint();
	if (!url) ok = false;
	//if (!call_state) {
	if (is_custom()) {
		let {abi, func} = update_abi();
		if (!abi) ok = false;
		// parse ta

	} else {
		let norm = update_name();
		if (!norm) ok = false;
	} 
	//}
	test_btn.disabled = !ok;
}

function update_func() {
	let custom = is_custom();
	ensip10_div.classList.toggle('hide', custom);
	custom_div.classList.toggle('hide', !custom);
	if (!custom) {


	}
	update_ux();
}

function make_call_data() {
	if (is_custom()) {

	} else {
		
	}
}

async function try_call() {
	let sender = '0x';
	let data = make_call_data();
	let url0 = parse_endpoint();
	let url = url0.replaceAll(TEMPLATE_SENDER, sender).replaceAll(TEMPLATE_DATA, data);
	let options = {};
	if (url === url0) {
		options.method = 'POST';
		options.headers['content-type'] = 'application/json';
		options.body = JSON.stringify({sender, data});
	}
	let t0 = Date.now();
	let res = await fetch(parse_endpoint(), options);
}

function add_field() {
	let row = create('div', {className: ['wide', 'field']});
	let profile_select = create('select', {className: 'profile_select'});
	profile_select.append(create('option', {value: 'text'}, 'Text(key)'));
	profile_select.append(create('option', {value: 'addrOld'}, 'Addr()'));
	profile_select.append(create('option', {value: 'addr'}, 'Addr(coin)'));
	profile_select.append(create('option', {value: 'chash'}, 'Contenthash()'));
	let arg_field = create('input', {className: 'arg_field'});
	row.append(profile_select, arg_field);
	ensip10_div.append(row);
}

function create(el, args, ...a) {
	if (typeof el === 'string') el = document.createElement(el);
	if (args) {
		for (let [k, v] of Object.entries(args)) {
			if (!v) continue;
			if (v instanceof Function) {
				el.addEventListener(k, v);
			} else if (k === 'dataset' || k === 'style') {
				Object.assign(el[k], v);
			} else if (k === 'className') {
				for (let x of [v].flat(Infinity)) {
					if (typeof x === 'string') {
						el.classList.add(x);
					} else if (x) {
						Object.entries(x).forEach(([k, v]) => el.classList.toggle(k, !!v));
					}
				}
			} else {
				el[k] = v;
			}
		}
	}
	el.append(...a);
	return el;
}
</script>
</body>
</html>
